/* @flow weak */

const execa = require('execa');

const needle = require('@knit/needle');

const knit = require('@knit/knit-core');

const tasks = [
  {
    title: 'getting last tag',
    skip: ctx => ctx.tag || ctx.forceAll,
    task: ctx => execa.stdout('git', ['describe', '--abbrev=0', '--tags']).then(tag => {
      ctx.tag = tag;
    }).catch(() => execa.stdout('git', ['rev-list', '--max-parents=0', 'HEAD']).then(commit => {
      ctx.tag = commit;
    })),
  },
  {
    title: 'determining updated modules since last release',
    skip: ctx => ctx.updated && `${ctx.updated.length} modules already found.`,
    task: ctx => knit.findUpdatedSince(ctx.modules, ctx.tag).then(updated => {
      ctx.updated = updated;
    }),
  },
];

module.exports = tasks;
