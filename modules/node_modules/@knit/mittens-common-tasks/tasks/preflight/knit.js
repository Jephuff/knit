/* @flow weak */

const execa = require('execa');
const Listr = require('listr');
const semver = require('semver');

const knit = require('@knit/knit-core');
const needle = require('@knit/needle');

const tasks = [
  {
    title: 'validating package.json',
    task: () => {
      ['version', 'repository'].forEach(field => {
        if (!needle.pkg[field]) {
          throw {
            message: 'incomplete package.json',
            stderr: `need to set \`${field}\` field in package.json`,
          };
        }
      });
    },
  },
  {
    title: 'check for missing dependencies',
    task: ctx => knit.findAllMissingDependencies(
        ctx.modules
      ).then(m => {
        if (m.length > 0) {
          throw {
            message: `found ${m.length} missing package${m.length > 1 ? 's' : ''}`,
            stderr: m.join(' '),
          }; }
        return true;
      }),
  },
  {
    title: 'check for unused dependencies',
    task: ctx => knit.findAllUnusedDependencies(
        ctx.modules
      ).then(m => {
        if (m.length > 0) {
          throw {
            message: `found ${m.length} unused package${m.length > 1 ? 's' : ''}`,
            stderr: m.join(' '),
          }; }
        return true;
      }),
  },
];

module.exports = tasks;
