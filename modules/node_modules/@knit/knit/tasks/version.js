/* @flow weak */

const execa = require('execa');
const path = require('path');
const writePkg = require('write-pkg');
const rx = require('@reactivex/rxjs');

const needle = require('@knit/needle');

const tasks = [
  {
    title: 'bumping version of updated modules',
    task: ctx => rx.Observable.create(observer => {
      ctx.updated.map(m => {
        observer.next(m);
        const pkg = Object.assign({}, ctx.pkgs[m], {
          version: ctx.version,
        });
        writePkg.sync(
          path.join(needle.paths.modules, m),
          pkg
        );
      });
      observer.complete();
    }),
  },
  {
    title: 'committing changes',
    task: ctx => execa('git', ['add', '.']),
  },
  {
    title: 'bumping package version',
    task: ctx => execa('yarn', [
      'version',
      '--new-version', ctx.version,
    ]),
  },
];

module.exports = tasks;
