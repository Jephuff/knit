/* @flow weak */

const Listr = require('listr');
const fs = require('fs-extra');
const chalk = require('chalk');
const pify = require('pify');
const path = require('path');

const tasks = require('@knit/mittens-common-tasks');
const errors = require('@knit/mittens-nice-errors');
const log = require('@knit/mittens-logger');

module.exports = argv => {
  const cwd = argv._[0];
   // check if dir exists
  pify(fs.stat)(cwd).then(() => {
    console.log();
    log.error(`directory \`${cwd}\` already exists`);
  }).catch(() => {
    console.log();
    log.info(`creating a new knit app in ${chalk.white(cwd)}`);
    console.log();
    new Listr([
      ...tasks.preflight.yarn,
      ...require('../tasks/init'),
    ], {
      renderer: log.getRenderer(),
    }).run({ cwd }).then(() => {
      console.log();
      log.success('finished creating your project!');
      console.log();
      log.info('start exploring by running:');
      console.log();
      console.log(chalk.cyan(`\tcd ${cwd}`));
      console.log(chalk.cyan('\tyarn start'));
      console.log();
      log.info('read more about what you can do with knit: ');
      log.info(chalk.white('https://github.com/knitjs/knit'));
    }).catch(errors.catchErrors);
  });
};
